<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Proxy values — mdb_proxy • thor</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Proxy values — mdb_proxy"><meta name="description" content="Proxy object.  These exist to try and exploit LMDB's copy-free
design.  LMDB can pass back a read-only pointer to memory without
copying it.  So rather than immediately trying to read the whole
thing in, this class provides a &quot;proxy&quot; to the data.  At the
moment they're not terribly useful - all you can do is get the
length, and peek at the first bytes!  They are used internally in
the package to support cursors."><meta property="og:description" content="Proxy object.  These exist to try and exploit LMDB's copy-free
design.  LMDB can pass back a read-only pointer to memory without
copying it.  So rather than immediately trying to read the whole
thing in, this class provides a &quot;proxy&quot; to the data.  At the
moment they're not terribly useful - all you can do is get the
length, and peek at the first bytes!  They are used internally in
the package to support cursors."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">thor</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/thor.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/richfitz/thor/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Proxy values</h1>
      <small class="dont-index">Source: <a href="https://github.com/richfitz/thor/blob/master/R/mdb_val_proxy.R" class="external-link"><code>R/mdb_val_proxy.R</code></a></small>
      <div class="d-none name"><code>mdb_proxy.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Proxy object.  These exist to try and exploit LMDB's copy-free
design.  LMDB can pass back a read-only pointer to memory without
copying it.  So rather than immediately trying to read the whole
thing in, this class provides a "proxy" to the data.  At the
moment they're not terribly useful - all you can do is get the
length, and peek at the first bytes!  They are used internally in
the package to support cursors.</p>
    </div>


    <div class="section level2">
    <h2 id="methods">Methods<a class="anchor" aria-label="anchor" href="#methods"></a></h2>



<dl><dt><code>data</code></dt>
<dd><p>Return the value from a proxy object</p>
<p><em>Usage:</em>
  <code>data(as_raw = NULL)</code></p>
<p><em>Arguments:</em></p><ul><li><p><code>as_raw</code>:   Return the value as a raw vector?  This has the same semantics as <code>mdb_env$get</code> - if <code>NULL</code> then the value will be returned as a string as possible, otherwise as a raw vector.  If <code>TRUE</code> then the value is always returned as a raw vector, and if <code>FALSE</code> then the value is always returned as a string (or an error is thrown if that is not possible).</p></li>
</ul><p><em>Value</em>:
  A string or raw vector</p></dd>

<dt><code>head</code></dt>
<dd><p>Read the first <code>n</code> bytes from a proxy</p>
<p><em>Usage:</em>
  <code>head(n = 6L, as_raw = NULL)</code></p>
<p><em>Arguments:</em></p><ul><li><p><code>n</code>:   The number of bytes to read.  If <code>n</code> is greater than the length of the object the whole object is returned (same behaviour as <code><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></code></p></li>
<li><p><code>as_raw</code>:   As for <code>$data()</code></p></li>
</ul></dd>

<dt><code>is_raw</code></dt>
<dd><p>Return whether we know a value to be raw or not.  This is affected by whether we have successfully turned the value into a string (in which case we can return <code>FALSE</code>) or if any <code>NULL</code> bytes have been detected.  The latter condition may be satisfied by reading the first bit of the proxy with <code>$head()</code></p>
<p><em>Usage:</em>
  <code>is_raw()</code></p>
<p><em>Value</em>:
  A logical if we can, otherwise <code>NULL</code> (for symmetry with <code>as_raw</code>)</p></dd>

<dt><code>is_valid</code></dt>
<dd><p>Test if a proxy object is still valid.  Once the proxy is invalid, it cannot be read from any more.  Proxies are invalidated if their parent transaction is closed, or if any write operations (e.g., <code>put</code>, <code>del</code>) have occurred.</p>
<p><em>Usage:</em>
  <code>is_valid()</code></p>
<p><em>Value</em>:
  Scalar logical</p></dd>

<dt><code>size</code></dt>
<dd><p>The size of the data - the number of characters in the string, or number of bytes in the raw vector.</p>
<p><em>Usage:</em>
  <code>size()</code></p>
<p><em>Value</em>:
  Scalar integer</p></dd>


</dl></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Start with a write transaction that has written a little data:</span></span></span>
<span class="r-in"><span><span class="va">env</span> <span class="op">&lt;-</span> <span class="fu">thor</span><span class="fu">::</span><span class="fu"><a href="mdb_env.html">mdb_env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">txn</span> <span class="op">&lt;-</span> <span class="va">env</span><span class="op">$</span><span class="fu">begin</span><span class="op">(</span>write <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">txn</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"apple"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">txn</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">"b"</span>, <span class="st">"banana"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We can get a proxy object back by passing as_proxy = TRUE</span></span></span>
<span class="r-in"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">txn</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span>, as_proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> &lt;mdb_val_proxy&gt;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   Public:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     data(as_raw = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     head(n = 6L, as_raw = NULL)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     is_raw()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     is_valid()</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     size()</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Without copying anything we can get the length of the data</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="op">)</span> <span class="co"># == nchar("apple")</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 5</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># And of course we can get the data</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "apple"</span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>as_raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 61 70 70 6c 65</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Referencing an invalid proxy is an error, but you can use</span></span></span>
<span class="r-in"><span><span class="co"># "is_valid()" check to see if it is valid</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">is_valid</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] TRUE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">txn</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">"c"</span>, <span class="st">"cabbage"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">p</span><span class="op">$</span><span class="fu">is_valid</span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Error in assert_valid() : </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   mdb_val_proxy is invalid: transaction has modified database</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># It is possible to read the first few bytes; this might be useful</span></span></span>
<span class="r-in"><span><span class="co"># to determine if (say) a value is a serialised R object:</span></span></span>
<span class="r-in"><span><span class="va">txn</span><span class="op">$</span><span class="fu">put</span><span class="op">(</span><span class="st">"d"</span>, <span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">serialize</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The first 6 bytes of a binary serialised rds object is always</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co">#   0x58 0x0a 0x00 0x00 0x00 0x02</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># for XDR serialisation, or</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co">#   0x42 0x0a 0x02 0x00 0x00 0x00</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># for native little-endian serialisation.</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># So with a little helper function</span></span></span>
<span class="r-in"><span><span class="va">is_rds</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">h_xdr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">as.raw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0x58</span>, <span class="fl">0x0a</span>, <span class="fl">0x00</span>, <span class="fl">0x00</span>, <span class="fl">0x00</span>, <span class="fl">0x02</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">h_bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/raw.html" class="external-link">as.raw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0x42</span>, <span class="fl">0x0a</span>, <span class="fl">0x02</span>, <span class="fl">0x00</span>, <span class="fl">0x00</span>, <span class="fl">0x00</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">x6</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">6L</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x6</span>, <span class="va">h_xdr</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">x6</span>, <span class="va">h_bin</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># We can see that the value stored at 'a' is not rds</span></span></span>
<span class="r-in"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">txn</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span>, as_proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">is_rds</span><span class="op">(</span><span class="va">p1</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="fl">6</span>, as_raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># But the value stored at 'd' is:</span></span></span>
<span class="r-in"><span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">txn</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"d"</span>, as_proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">is_rds</span><span class="op">(</span><span class="va">p2</span><span class="op">$</span><span class="fu">head</span><span class="op">(</span><span class="fl">6</span>, as_raw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] FALSE</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Retrieve and unserialise the value:</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/serialize.html" class="external-link">unserialize</a></span><span class="op">(</span><span class="va">p2</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>                    mpg cyl disp  hp drat    wt  qsec vs am gear carb</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn, Howard Chu, Martin Hedenfalk.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

