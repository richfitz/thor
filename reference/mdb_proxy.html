<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Proxy values — mdb_proxy • thor</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Proxy values — mdb_proxy" />
<meta property="og:description" content="Proxy object.  These exist to try and exploit LMDB's copy-free
design.  LMDB can pass back a read-only pointer to memory without
copying it.  So rather than immediately trying to read the whole
thing in, this class provides a &quot;proxy&quot; to the data.  At the
moment they're not terribly useful - all you can do is get the
length, and peek at the first bytes!  They are used internally in
the package to support cursors." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">thor</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/thor.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/richfitz/thor/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Proxy values</h1>
    <small class="dont-index">Source: <a href='https://github.com/richfitz/thor/blob/master/R/mdb_val_proxy.R'><code>R/mdb_val_proxy.R</code></a></small>
    <div class="hidden name"><code>mdb_proxy.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Proxy object.  These exist to try and exploit LMDB's copy-free
design.  LMDB can pass back a read-only pointer to memory without
copying it.  So rather than immediately trying to read the whole
thing in, this class provides a "proxy" to the data.  At the
moment they're not terribly useful - all you can do is get the
length, and peek at the first bytes!  They are used internally in
the package to support cursors.</p>
    </div>



    <h2 class="hasAnchor" id="methods"><a class="anchor" href="#methods"></a>Methods</h2>

    


<dl>
<dt><code>data</code></dt><dd><p>Return the value from a proxy object  <em>Usage:</em>
  <code><a href='https://rdrr.io/r/utils/data.html'>data(as_raw = NULL)</a></code>  <em>Arguments:</em>
  <ul>
<li><p><code>as_raw</code>:   Return the value as a raw vector?  This has the same semantics as <code>mdb_env$get</code> - if <code>NULL</code> then the value will be returned as a string as possible, otherwise as a raw vector.  If <code>TRUE</code> then the value is always returned as a raw vector, and if <code>FALSE</code> then the value is always returned as a string (or an error is thrown if that is not possible).</p></li>
</ul>  <em>Value</em>:
  A string or raw vector</p></dd>
<dt><code>head</code></dt><dd><p>Read the first <code>n</code> bytes from a proxy  <em>Usage:</em>
  <code><a href='https://rdrr.io/r/utils/head.html'>head(n = 6L, as_raw = NULL)</a></code>  <em>Arguments:</em>
  <ul>
<li><p><code>n</code>:   The number of bytes to read.  If <code>n</code> is greater than the length of the object the whole object is returned (same behaviour as <code><a href='https://rdrr.io/r/utils/head.html'>head</a></code></p></li>
<li><p><code>as_raw</code>:   As for <code>$data()</code></p></li>
</ul></p></dd>
<dt><code>is_raw</code></dt><dd><p>Return whether we know a value to be raw or not.  This is affected by whether we have successfully turned the value into a string (in which case we can return <code>FALSE</code>) or if any <code>NULL</code> bytes have been detected.  The latter condition may be satisfied by reading the first bit of the proxy with <code>$head()</code>  <em>Usage:</em>
  <code>is_raw()</code>  <em>Value</em>:
  A logical if we can, otherwise <code>NULL</code> (for symmetry with <code>as_raw</code>)</p></dd>
<dt><code>is_valid</code></dt><dd><p>Test if a proxy object is still valid.  Once the proxy is invalid, it cannot be read from any more.  Proxies are invalidated if their parent transaction is closed, or if any write operations (e.g., <code>put</code>, <code>del</code>) have occurred.  <em>Usage:</em>
  <code>is_valid()</code>  <em>Value</em>:
  Scalar logical</p></dd>
<dt><code>size</code></dt><dd><p>The size of the data - the number of characters in the string, or number of bytes in the raw vector.  <em>Usage:</em>
  <code>size()</code>  <em>Value</em>:
  Scalar integer</p></dd>

</dl>


    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># Start with a write transaction that has written a little data:</span>
<span class='va'>env</span> <span class='op'>&lt;-</span> <span class='fu'>thor</span><span class='fu'>::</span><span class='fu'><a href='mdb_env.html'>mdb_env</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/tempfile.html'>tempfile</a></span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
<span class='va'>txn</span> <span class='op'>&lt;-</span> <span class='va'>env</span><span class='op'>$</span><span class='fu'>begin</span><span class='op'>(</span>write <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='va'>txn</span><span class='op'>$</span><span class='fu'>put</span><span class='op'>(</span><span class='st'>"a"</span>, <span class='st'>"apple"</span><span class='op'>)</span>
<span class='va'>txn</span><span class='op'>$</span><span class='fu'>put</span><span class='op'>(</span><span class='st'>"b"</span>, <span class='st'>"banana"</span><span class='op'>)</span>

<span class='co'># We can get a proxy object back by passing as_proxy = TRUE</span>
<span class='va'>p</span> <span class='op'>&lt;-</span> <span class='va'>txn</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"a"</span>, as_proxy <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='va'>p</span>
</div><div class='output co'>#&gt; &lt;mdb_val_proxy&gt;
#&gt;   Public:
#&gt;     data(as_raw = NULL)
#&gt;     head(n = 6L, as_raw = NULL)
#&gt;     is_raw()
#&gt;     is_valid()
#&gt;     size()</div><div class='input'>
<span class='co'># Without copying anything we can get the length of the data</span>
<span class='va'>p</span><span class='op'>$</span><span class='fu'>size</span><span class='op'>(</span><span class='op'>)</span> <span class='co'># == nchar("apple")</span>
</div><div class='output co'>#&gt; [1] 5</div><div class='input'>
<span class='co'># And of course we can get the data</span>
<span class='va'>p</span><span class='op'>$</span><span class='fu'>data</span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] "apple"</div><div class='input'><span class='va'>p</span><span class='op'>$</span><span class='fu'>data</span><span class='op'>(</span>as_raw <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] 61 70 70 6c 65</div><div class='input'>
<span class='co'># Referencing an invalid proxy is an error, but you can use</span>
<span class='co'># "is_valid()" check to see if it is valid</span>
<span class='va'>p</span><span class='op'>$</span><span class='fu'>is_valid</span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] TRUE</div><div class='input'>
<span class='va'>txn</span><span class='op'>$</span><span class='fu'>put</span><span class='op'>(</span><span class='st'>"c"</span>, <span class='st'>"cabbage"</span><span class='op'>)</span>
<span class='va'>p</span><span class='op'>$</span><span class='fu'>is_valid</span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] FALSE</div><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/try.html'>try</a></span><span class='op'>(</span><span class='va'>p</span><span class='op'>$</span><span class='fu'>data</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Error in assert_valid() : 
#&gt;   mdb_val_proxy is invalid: transaction has modified database</div><div class='input'>
<span class='co'># It is possible to read the first few bytes; this might be useful</span>
<span class='co'># to determine if (say) a value is a serialised R object:</span>
<span class='va'>txn</span><span class='op'>$</span><span class='fu'>put</span><span class='op'>(</span><span class='st'>"d"</span>, <span class='fu'><a href='https://rdrr.io/r/base/serialize.html'>serialize</a></span><span class='op'>(</span><span class='va'>mtcars</span>, <span class='cn'>NULL</span><span class='op'>)</span><span class='op'>)</span>

<span class='co'># The first 6 bytes of a binary serialised rds object is always</span>
<span class='co'>#</span>
<span class='co'>#   0x58 0x0a 0x00 0x00 0x00 0x02</span>
<span class='co'>#</span>
<span class='co'># for XDR serialisation, or</span>
<span class='co'>#</span>
<span class='co'>#   0x42 0x0a 0x02 0x00 0x00 0x00</span>
<span class='co'>#</span>
<span class='co'># for native little-endian serialisation.</span>
<span class='co'>#</span>
<span class='co'># So with a little helper function</span>
<span class='va'>is_rds</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>h_xdr</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/raw.html'>as.raw</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0x58</span>, <span class='fl'>0x0a</span>, <span class='fl'>0x00</span>, <span class='fl'>0x00</span>, <span class='fl'>0x00</span>, <span class='fl'>0x02</span><span class='op'>)</span><span class='op'>)</span>
  <span class='va'>h_bin</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/raw.html'>as.raw</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0x42</span>, <span class='fl'>0x0a</span>, <span class='fl'>0x02</span>, <span class='fl'>0x00</span>, <span class='fl'>0x00</span>, <span class='fl'>0x00</span><span class='op'>)</span><span class='op'>)</span>
  <span class='va'>x6</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='va'>x</span>, <span class='fl'>6L</span><span class='op'>)</span>
  <span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>x6</span>, <span class='va'>h_xdr</span><span class='op'>)</span> <span class='op'>||</span> <span class='fu'><a href='https://rdrr.io/r/base/identical.html'>identical</a></span><span class='op'>(</span><span class='va'>x6</span>, <span class='va'>h_bin</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='co'># We can see that the value stored at 'a' is not rds</span>
<span class='va'>p1</span> <span class='op'>&lt;-</span> <span class='va'>txn</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"a"</span>, as_proxy <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='fu'>is_rds</span><span class='op'>(</span><span class='va'>p1</span><span class='op'>$</span><span class='fu'>head</span><span class='op'>(</span><span class='fl'>6</span>, as_raw <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] FALSE</div><div class='input'>
<span class='co'># But the value stored at 'd' is:</span>
<span class='va'>p2</span> <span class='op'>&lt;-</span> <span class='va'>txn</span><span class='op'>$</span><span class='fu'>get</span><span class='op'>(</span><span class='st'>"d"</span>, as_proxy <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>
<span class='fu'>is_rds</span><span class='op'>(</span><span class='va'>p2</span><span class='op'>$</span><span class='fu'>head</span><span class='op'>(</span><span class='fl'>6</span>, as_raw <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt; [1] FALSE</div><div class='input'>
<span class='co'># Retrieve and unserialise the value:</span>
<span class='fu'><a href='https://rdrr.io/r/utils/head.html'>head</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/serialize.html'>unserialize</a></span><span class='op'>(</span><span class='va'>p2</span><span class='op'>$</span><span class='fu'>data</span><span class='op'>(</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</div><div class='output co'>#&gt;                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
#&gt; Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
#&gt; Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
#&gt; Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
#&gt; Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
#&gt; Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
#&gt; Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Rich FitzJohn, Howard Chu, Martin Hedenfalk.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


